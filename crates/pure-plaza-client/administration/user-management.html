<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Confilogi IT Support - User management</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="/tailwind.css">
	</head>
	<body class="bg-neutral-950 text-neutral-200 min-h-screen flex flex-col">
		<div id="error-modal-root"></div>
		<!-- Root for user modals -->
		<div id="user-modal-root"></div>
		<!-- Suspense/loader root -->
		<div id="loading-screen"></div>
		<!-- Navbar -->
		<div id="navbar-root"></div>

		<!-- Main -->
		<main class="flex-1">
			<section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
				<!-- Page header -->
				<div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
					<div>
						<h1 class="text-xl sm:text-2xl font-semibold">User management</h1>
						<p class="text-neutral-400 text-sm">See the data of the users.</p>
					</div>
				</div>

				<!-- Summary -->
				<div class="flex items-center justify-between mb-3">
					<p id="results-summary" class="text-sm text-neutral-400">Showing 0 users</p>
				</div>

				<!-- Mobile list (cards) -->
				<div id="users-cards-root" class="grid grid-cols-1 gap-3 md:hidden"></div>

				<!-- Desktop table (md+) -->
				<div id="users-table-wrapper" class="hidden md:block bg-neutral-900/60 ring-1 ring-neutral-800 rounded-2xl overflow-hidden">
					<div class="overflow-x-auto">
						<table class="min-w-full divide-y divide-neutral-800">
							<thead class="bg-neutral-900/60">
								<tr>
									<th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-neutral-400 uppercase tracking-wider">Name</th>
									<th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-neutral-400 uppercase tracking-wider">Email</th>
									<th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-neutral-400 uppercase tracking-wider">Job title</th>
									<th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-neutral-400 uppercase tracking-wider">Status</th>
								</tr>
							</thead>
							<tbody id="users-tbody" class="divide-y divide-neutral-800"></tbody>
						</table>
					</div>
				</div>

				<div id="table-end-sentinel" aria-hidden="true"></div>

				<!-- Empty state (hidden by default) -->
				<div id="empty-state" class="hidden mt-4">
					<div class="bg-neutral-900/60 ring-1 ring-neutral-800 rounded-2xl p-6 text-center">
						<p class="text-neutral-300 mb-2">No users match your filters.</p>
						<p class="text-neutral-500 text-sm">Try adjusting filters or reset to view all users.</p>
					</div>
				</div>
			</section>
		</main>

		<!-- Scripts -->
		<script src="/main.js"></script>
		<script src="/components/navbar/main.js"></script>
		<script src="/components/text_field/main.js"></script>
		<script src="/components/select_field/main.js"></script>
		<script src="/components/modal/main.js"></script>
		<script src="/components/button/main.js"></script>
		<script src="/components/suspense_screen/main.js"></script>
		<script>
		const loadingScreen = mountSuspenseScreen("#loading-screen", {
			message: "Loading needed data...",
		});

		(async () => {
			try {
				const apiConnector = createApiConnector();
				const authStore = createAuthStore();

				await checkIsLoggedInMiddleware(authStore);

				let endReached = false;
				let nextCursor = 1;
				let total = 0;
				let users = [];

				async function fetchUsers() {
					let paginatedUsersResponse = await apiConnector.getPaginatedUsers(30, nextCursor);

					if (paginatedUsersResponse.unknownError !== null) {
						throw paginatedUsersResponse.unknownError;
					} else {
						const { items, nextCursor: responseNextCursor, total: responseTotal } = paginatedUsersResponse.ok;
						users = users.concat(items);
						nextCursor = responseNextCursor;
						total = responseTotal;

						if (items.length === 0) endReached = true;
					}
				}

				await fetchUsers();

				loadingScreen.destroy();

				const navbar = mountNavbar('#navbar-root', {
					brandHref: '/',
					brandName: 'Confilogi',
					brandAccent: 'IT Support',
					...LOGGED_IN_NAVBAR_ARGS
				});

				const tbody = document.getElementById('users-tbody');
				const summaryEl = document.getElementById('results-summary');
				const emptyStateEl = document.getElementById('empty-state');
				const cardsRoot = document.getElementById('users-cards-root');

				function statusBadgeClasses(status) {
					return status === 'Active'
						? 'bg-green-500/20 text-green-400'
						: 'bg-red-500/20 text-red-400';
				}

				function render() {
					summaryEl.textContent = `Showing ${users.length} of ${total} users`;

					if (users.length === 0) {
						tbody.innerHTML = '';
						cardsRoot.innerHTML = '';
						emptyStateEl.classList.remove('hidden');
						return;
					}
					emptyStateEl.classList.add('hidden');

					const rowsHtml = users.map(u => {
						return `
<tr class="hover:bg-neutral-900/40 transition">
<td class="px-4 py-3 align-top">
<div class="flex flex-col">
<span class="font-semibold">${escapeHtml(u.fullName)}</span>
<span class="text-xs text-neutral-400">ID: ${escapeHtml(u.id)}</span>
</div>
</td>
<td class="px-4 py-3 align-top">
<span class="text-neutral-300">${escapeHtml(u.email)}</span>
</td>
<td class="px-4 py-3 align-top">
<span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md ring-1 ring-neutral-800 bg-neutral-800 text-neutral-300">${escapeHtml(u.jobTitle.name || u.jobTitle.intranetName)}</span>
<span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md ring-1 ring-neutral-800 bg-neutral-800 text-neutral-300">${escapeHtml(u.companyDepartment?.name || "No department")}</span>

</td>
<td class="px-4 py-3 align-top">
<span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md ring-1 ring-neutral-800 ${statusBadgeClasses(u.isActive ? 'Active' : 'Disabled')}">${escapeHtml(u.isActive ? 'Active' : 'Disabled')}</span>
</td>
</tr>
`;
					}).join('');
					tbody.innerHTML = rowsHtml;

					const cardsHtml = users.map(u => {
						return `
<article class="bg-neutral-900/60 ring-1 ring-neutral-800 rounded-2xl p-4 flex flex-col gap-3 hover:bg-neutral-900 transition">
<div class="flex items-start justify-between gap-3">
<div>
<h2 class="text-base font-semibold leading-snug">${escapeHtml(u.fullName)}</h2>
<p class="text-sm text-neutral-400">${escapeHtml(u.email)}</p>
</div>
<span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md ring-1 ring-neutral-800 ${statusBadgeClasses(u.isActive ? 'Active' : 'Disabled')}">
${escapeHtml(u.isActive ? 'Active' : 'Disabled')}
</span>
</div>
<div class="flex items-center gap-2">
<span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md ring-1 ring-neutral-800 bg-neutral-800 text-neutral-300">
${escapeHtml(u.jobTitle?.name || u.jobTitle.intranetName)}
</span>
<span class="text-xs text-neutral-500">ID: ${escapeHtml(u.id)}</span>
</div>
</article>
`;
					}).join('');
					cardsRoot.innerHTML = cardsHtml;
				}

				// Initial render
				render();

				const sentinel = document.getElementById('table-end-sentinel');
				const observer = new IntersectionObserver(async ([entry]) => {
					if (entry.isIntersecting) {
						try {
							if (!endReached) {
								const loadingScreen = mountSuspenseScreen("#loading-screen", {
									message: "Loading next items...",
								});

								await fetchUsers();
								render();

								loadingScreen.destroy();
							}
						} catch (error) {
							reportCriticalError(error);
						}
					}
				}, {
					root: null,
					threshold: 0,
					rootMargin: '0px 0px 150px 0px'
				});
				observer.observe(sentinel);

			} catch (error) {
				reportCriticalError(error);
			}
		})();
		</script>
	</body>
</html>
