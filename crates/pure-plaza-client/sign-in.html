<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Login</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="/tailwind.css">
	</head>
	<body class="bg-neutral-950 text-neutral-200 min-h-screen flex flex-col">
		<div id="error-modal-root"></div>
		<div id="loading-screen-root"></div>
		<!-- Navbar -->
		<div id="navbar-root"></div>

		<!-- Main -->
		<main class="flex-1 flex items-center justify-center px-4 py-12">
			<div class="w-full max-w-md">
				<form id="login-form" class="bg-neutral-900/60 ring-1 ring-neutral-800 rounded-2xl p-6 shadow-lg">
					<h1 class="text-xl font-semibold mb-6">Sign in via Microsoft</h1>

					<p class="mb-6">Redirecting to Microsoft authentication in <span id="redirection-timer"></span>...</p>

					<div class="flex items-center justify-between mb-4">
						<!-- Forgot Password -->
						<div id="redirect-now-btn"></div>
						<!-- Spacer -->
						<div class="flex-1"></div>
						<!-- Submit -->
						<div id="emergency-sign-in-btn"></div>
					</div>

				</div>
			</div>
		</main>

		<script src="./main.js"></script>
		<script src="./components/navbar/main.js"></script>
		<script src="./components/text_field/main.js"></script>
		<script src="./components/button/main.js"></script>
		<script src="./components/modal/main.js"></script>
		<script src="./components/suspense_screen/main.js"></script>

		<script>
		const authStore = createAuthStore();

		const loadingScreen = mountSuspenseScreen("#loading-screen-root", {
			message: "Loading needed data...",
		});

		const apiConnector = createApiConnector();

		(async () => {
			try {
				await checkIsGuestMiddleware(authStore);

				const microsoftUri = await apiConnector.getMicrosoftSignInRedirectionUri()
					.then(result => {
						if (result.unknownError !== null) {
							throw result.unknownError;
						}

						return result.ok;
					});

				loadingScreen.destroy();

				const navbar = mountNavbar('#navbar-root', {
					brandHref: '/',
					brandName: 'Confilogi',
					brandAccent: 'IT Support',
					...LOGGED_OUT_NAVBAR_ARGS
				});

				const redirectNowButton = mountButton('#redirect-now-btn', {
					label: 'Redirect now',
					variant: 'primary',
					size: 'md',
					type: 'button',
					href: microsoftUri
				});

				const emergencySignInButton = mountButton('#emergency-sign-in-btn', {
					label: 'Emergency sign in',
					variant: 'secondary',
					size: 'sm',
					type: 'button',
					href: '/emergency-sign-in.html'
				});

				let redirectIn = 5;

				const redirectionTick = () => {
					redirectIn--;

					if (redirectIn < 0) {
						window.location.href = microsoftUri;
					} else {
						document.querySelector("#redirection-timer").innerHTML = redirectIn;
					}
				}

				redirectionTick();

				setInterval(redirectionTick, 1000);

			} catch (error) {
				reportCriticalError(error);
			}
		})();
		</script>
	</body>
</html>
