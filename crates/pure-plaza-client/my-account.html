<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Confilogi IT Support - My account</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="/tailwind.css">
	</head>
	<body class="bg-neutral-950 text-neutral-200 min-h-screen flex flex-col">
		<div id="error-modal-root"></div>
		<!-- Suspense/loader root -->
		<div id="loading-screen"></div>
		<!-- Navbar -->
		<div id="navbar-root"></div>

		<!-- Main -->
		<main class="flex-1">
			<section class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-8">
				<!-- Page header -->
				<div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-6">
					<div>
						<h1 class="text-xl sm:text-2xl font-semibold">My account</h1>
						<p class="text-neutral-400 text-sm">View your profile details and change your password.</p>
					</div>
				</div>

				<!-- Profile card -->
				<div class="bg-neutral-900/60 ring-1 ring-neutral-800 rounded-2xl p-5 sm:p-6 mb-6">
					<h2 class="text-lg font-semibold mb-4">Profile</h2>
					<div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
						<div class="bg-neutral-900/40 ring-1 ring-neutral-800 rounded-xl p-4">
							<p class="text-sm text-neutral-400">Full name</p>
							<p id="profile-name" class="mt-1 font-medium text-neutral-100"></p>
						</div>
						<div class="bg-neutral-900/40 ring-1 ring-neutral-800 rounded-xl p-4">
							<p class="text-sm text-neutral-400">Email</p>
							<p id="profile-email" class="mt-1 font-medium text-neutral-100"></p>
						</div>
						<div class="bg-neutral-900/40 ring-1 ring-neutral-800 rounded-xl p-4">
							<p class="text-sm text-neutral-400">Job title</p>
							<p id="profile-job" class="mt-1 font-medium text-neutral-100"></p>
						</div>
						<div class="bg-neutral-900/40 ring-1 ring-neutral-800 rounded-xl p-4">
							<p class="text-sm text-neutral-400">Department</p>
							<p id="profile-dept" class="mt-1 font-medium text-neutral-100"></p>
						</div>
					</div>
				</div>

				<!-- Change password card -->
				<div class="bg-neutral-900/60 ring-1 ring-neutral-800 rounded-2xl p-5 sm:p-6">
					<div class="flex items-start justify-between gap-3 mb-4">
						<h2 class="text-lg font-semibold">Change password</h2>
						<p class="text-xs text-neutral-500">Ensure your password is unique and strong</p>
					</div>

					<p>In the future there will be an emergency sing in with password, you will be able to change the password for it here ;)</p>

					<!--
					<div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
						<div id="field-current-pwd"></div>
						<div></div>
						<div id="field-new-pwd"></div>
						<div id="field-confirm-pwd"></div>
					</div>

					<ul class="mt-3 text-xs text-neutral-400 list-disc pl-5 space-y-1">
						<li>At least 8 characters</li>
						<li>At least 1 uppercase, 1 lowercase and 1 number</li>
						<li>No spaces; avoid reusing old passwords</li>
					</ul>

					<div class="mt-5 flex items-center justify-end gap-3">
						<div id="change-password-btn"></div>
					</div>
					-->
				</div>
			</section>
		</main>

		<!-- Scripts -->
		<script src="/main.js"></script>
		<script src="/components/navbar/main.js"></script>
		<script src="/components/text_field/main.js"></script>
		<script src="/components/select_field/main.js"></script>
		<script src="/components/textarea_field/main.js"></script>
		<script src="/components/modal/main.js"></script>
		<script src="/components/button/main.js"></script>
		<script src="/components/suspense_screen/main.js"></script>

		<script>
		const loadingScreen = mountSuspenseScreen("#loading-screen", {
			message: "Loading needed data...",
		});

		(async () => {
			try {
				const apiConnector = createApiConnector();
				const authStore = createAuthStore();

				await checkIsLoggedInMiddleware(authStore);

				loadingScreen.destroy();

				const navbar = mountNavbar('#navbar-root', {
					brandHref: '/',
					brandName: 'Confilogi',
					brandAccent: 'IT Support',
					...LOGGED_IN_NAVBAR_ARGS
				});

				// Current user (injected by server or fallback demo)
				const CURRENT_USER = authStore.getLoggedInUser();


				// Populate profile card safely
				document.getElementById('profile-name').textContent  = CURRENT_USER.fullName || '';
				document.getElementById('profile-email').textContent = CURRENT_USER.email || '';
				document.getElementById('profile-job').textContent   = CURRENT_USER.jobTitle.name || CURRENT_USER.jobTitle.intranet_name;
				document.getElementById('profile-dept').textContent  = CURRENT_USER.companyDepartment?.name || 'No department specified';

				// Password fields [3]
				// const currentPwdField = mountTextField('#field-current-pwd', {
				// 	type: 'password',
				// 	label: 'Current password',
				// 	placeholder: 'Enter current password',
				// 	value: '',
				// 	clearErrorOnInput: true,
				// }); // [3]
				//
				// const newPwdField = mountTextField('#field-new-pwd', {
				// 	type: 'password',
				// 	label: 'New password',
				// 	placeholder: 'Enter new password',
				// 	value: '',
				// 	clearErrorOnInput: true,
				// 	onInput: () => validateAll()
				// }); // [3]
				//
				// const confirmPwdField = mountTextField('#field-confirm-pwd', {
				// 	type: 'password',
				// 	label: 'Confirm new password',
				// 	placeholder: 'Re-enter new password',
				// 	value: '',
				// 	clearErrorOnInput: true,
				// 	onInput: () => validateAll()
				// }); // [3]
				//
				// // Change password button [4]
				// const changeBtn = mountButton('#change-password-btn', {
				// 	label: 'Change password',
				// 	variant: 'primary',
				// 	size: 'md',
				// 	onClick: () => handleChangePassword()
				// }); // [4]
				//
				// Modal helper [6]
				// function showModal(title, html) {
				// 	const modal = mountModal('#error-modal-root', {
				// 		title: title,
				// 		contentHtml: html || '',
				// 		size: 'sm',
				// 		closeOnEsc: true,
				// 		closeOnBackdrop: true,
				// 		showCloseButton: true,
				// 		secondaryAction: { label: 'Close', onClick: (_, api) => { api.close(); modal.destroy(); } }
				// 	}); // [6]
				// 	modal.open(); // [6]
				// 	return modal;
				// }
				//
				// // Loader wrapper (adds slight delay for UX parity) [2]
				// function withLoader(message, hint, fn) {
				// 	loader.setMessage(message || 'Working...');
				// 	if (hint == null) loader.setHint(null); else loader.setHint(hint);
				// 	loader.show();
				// 	return new Promise((resolve, reject) => {
				// 		setTimeout(async () => {
				// 			try { resolve(await fn()); }
				// 			catch (e) { reject(e); }
				// 			finally { loader.hide(); }
				// 		}, 400);
				// 	});
				// }
				//
				// // Password validation logic
				// function validateNewPassword(pwd) {
				// 	if (!pwd || pwd.length < 8) return 'Password must be at least 8 characters';
				// 	if (/\s/.test(pwd)) return 'Password cannot contain spaces';
				// 	if (!/[a-z]/.test(pwd) || !/[A-Z]/.test(pwd) || !/[0-9]/.test(pwd)) {
				// 		return 'Use upper, lower case letters and a number';
				// 	}
				// 	return null;
				// }
				//
				// function validateAll() {
				// 	// Clear previous field-level errors (onInput clears automatically when enabled) [3]
				// 	let ok = true;
				//
				// 	// New password checks
				// 	const newPwd = newPwdField.getValue();
				// 	const err = validateNewPassword(newPwd);
				// 	if (err) { newPwdField.setError(err); ok = false; } else { newPwdField.clearError(); } // [3]
				//
				// 	// Confirm matches
				// 	const confirmPwd = confirmPwdField.getValue();
				// 	if (newPwd && confirmPwd && newPwd !== confirmPwd) {
				// 		confirmPwdField.setError('Passwords do not match'); ok = false; // [3]
				// 	} else {
				// 		confirmPwdField.clearError(); // [3]
				// 	}
				//
				// 	// Current password present
				// 	const curr = currentPwdField.getValue();
				// 	if (!curr || curr.trim().length === 0) {
				// 		// Don't block typing flow with error until submit; keep button state accurate
				// 		ok = false;
				// 	}
				//
				// 	// Prevent trivial reuse
				// 	if (curr && newPwd && curr === newPwd) {
				// 		newPwdField.setError('New password must differ from current'); ok = false; // [3]
				// 	}
				//
				// 	// Enable/disable button based on validity
				// 	changeBtn.setDisabled(!ok); // [4]
				// 	return ok;
				// }
				//
				// // Initialize button disabled until valid
				// changeBtn.setDisabled(true); // [4]
				//
				// async function handleChangePassword() {
				// 	// Validate again on submit
				// 	const curr = currentPwdField.getValue();
				// 	const next = newPwdField.getValue();
				// 	const conf = confirmPwdField.getValue();
				//
				// 	// Basic checks
				// 	let ok = true;
				// 	if (!curr || curr.trim().length === 0) {
				// 		currentPwdField.setError('Enter your current password'); ok = false; // [3]
				// 	} else {
				// 		currentPwdField.clearError(); // [3]
				// 	}
				// 	const errNext = validateNewPassword(next);
				// 	if (errNext) { newPwdField.setError(errNext); ok = false; } else { newPwdField.clearError(); } // [3]
				// 	if (next !== conf) { confirmPwdField.setError('Passwords do not match'); ok = false; } else { confirmPwdField.clearError(); } // [3]
				// 	if (curr && next && curr === next) { newPwdField.setError('New password must differ from current'); ok = false; } // [3]
				//
				// 	if (!ok) { validateAll(); return; }
				//
				// 	// Simulated request (replace with real API call)
				// 	function updatePasswordAPI(currentPwd, newPwd) {
				// 		// In real implementation, call backend and handle errors
				// 		// Here we simulate success; you can simulate "wrong current password" by returning a rejected Promise
				// 		return new Promise((resolve) => setTimeout(resolve, 350));
				// 	}
				//
				// 	try {
				// 		changeBtn.setLoading(true); // [4]
				// 		await withLoader('Updating password...', 'Securing your account', async () => {
				// 			await updatePasswordAPI(curr, next);
				// 		});
				// 		changeBtn.setLoading(false); // [4]
				// 		// Clear fields after success
				// 		currentPwdField.clear({ silent: true }); // [3]
				// 		newPwdField.clear({ silent: true });     // [3]
				// 		confirmPwdField.clear({ silent: true }); // [3]
				// 		validateAll();
				// 		showModal('Password changed', '<p class="text-neutral-300">Your password was updated successfully.</p>'); // [6]
				// 	} catch (e) {
				// 		changeBtn.setLoading(false); // [4]
				// 		showModal('Password change failed', '<p class="text-neutral-300">We could not update your password. Please try again.</p>'); // [6]
				// 	}
				// }
				//
				// // Optional: Enter key on confirm triggers submit
				// confirmPwdField.inputEl.addEventListener('keydown', (e) => {
				// 	if (e.key === 'Enter') {
				// 		handleChangePassword();
				// 	}
				// });
			} catch (error) {
				reportCriticalError(error);
			}
		})();
		</script>
	</body>
</html>
