<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Confilogi IT Support - Report onboarding</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="/tailwind.css">
	</head>
	<body class="bg-neutral-950 text-neutral-200 min-h-screen flex flex-col">
		<div id="error-modal-root"></div>

		<div id="loading-screen"></div>

		<!-- Navbar -->
		<div data-loading="show" class="hidden" id="navbar-root"></div>

		<!-- Main -->
		<main data-loading="show" class="flex-1 hidden">
			<section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
				<!-- Page header -->
				<div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
					<div>
						<h1 class="text-xl sm:text-2xl font-semibold">Report onboarding</h1>
						<p class="text-neutral-400 text-sm">Provide basic information about the person and their postal address.</p>
					</div>
					<div class="text-xs text-neutral-500">
						All fields are required unless marked as optional
					</div>
				</div>

				<!-- Form card -->
				<form id="address-form" class="bg-neutral-900/60 ring-1 ring-neutral-800 rounded-2xl p-6 sm:p-8 shadow-lg mb-6">
					<!-- Basic data -->
					<section class="mb-8">
						<h2 class="text-lg font-semibold mb-4">Basic data</h2>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
							<div id="first-name-field"></div>
							<div id="second-name-field"></div>
							<div id="last-name-field"></div>
						</div>

						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
							<div id="company-department-field"></div>
							<div id="job-title-field"></div>
							<div class="md:col-span-2 lg:col-span-1" id="job-subtitle-field"></div>
						</div>
					</section>

					<!-- Previous employment -->
					<section class="mb-8">
						<h2 class="text-lg font-semibold mb-4">Employment history</h2>
						<div class="flex items-center justify-between rounded-xl ring-1 ring-inset ring-neutral-800 bg-neutral-950/60 p-4">
							<div class="flex-1">
								<p class="text-sm font-medium">Did this person work with us in the past?</p>
								<p class="text-xs text-neutral-500 mt-1">Toggle to mark previous employment.</p>
							</div>
							<!-- Toggle -->
							<div id="worked-before-switch"></div>
						</div>
					</section>

					<!-- Postal Address -->
					<section class="mb-8">
						<h2 class="text-lg font-semibold mb-4">Postal address</h2>
						<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
							<div id="street-field"></div>
							<div id="house-number-field"></div>
							<div id="apartment-number-field"></div>
							<div id="country-field"></div>
							<div id="city-field"></div>
							<div id="postal-code-field"></div>
							<div id="phone-field"></div>
							<div id="email-field"></div>
						</div>
					</section>
				</form>

				<form id="hardware-form" class="bg-neutral-900/60 ring-1 ring-neutral-800 rounded-2xl p-6 sm:p-8 shadow-lg mb-8">
					<!-- Basic data -->
					<section class="mb-8">
						<h2 class="text-lg font-semibold mb-4">Requested hardware</h2>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
							<div id="hardware-laptop-checkbox-root"></div>
							<div id="hardware-mouse-checkbox-root"></div>
							<div id="hardware-headset-checkbox-root"></div>
						</div>
						<div class="flex items-center justify-between rounded-xl ring-1 ring-inset ring-neutral-800 bg-neutral-950/60 p-4">
							<div class="flex-1">
								<p class="text-sm font-medium">Special needs section</p>
								<p class="text-xs text-neutral-500 mt-1 mb-4">Warning! All of the items inside this section are <span class="font-extrabold text-red-500/75">NOT ON-SITE</span> and can cause a time delay for your ticket.</p>

								<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
									<div id="hardware-usb-c-network-card-checkbox-root"></div>
									<div id="hardware-usb-a-wireless-network-card-checkbox-root"></div>
									<div id="hardware-laptop-bag-checkbox-root"></div>
									<div id="hardware-phone-checkbox-root"></div>
									<div id="hardware-phone-charger-checkbox-root"></div>
								</div>
							</div>
							<!-- Toggle -->
							<div id="worked-before-switch"></div>
						</div>
					</section>
				</form>

				<form id="permissions-form" class="bg-neutral-900/60 ring-1 ring-neutral-800 rounded-2xl p-6 sm:p-8 shadow-lg mb-8">
					<!-- Basic data -->
					<section class="mb-8">
						<h2 class="text-lg font-semibold mb-4">Requested permissions</h2>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
							<div id="master-systems-field"></div>
							<div id="licenses-field"></div>
							<div id="groups-field"></div>
						</div>
						<div id="subpermissions-wrapper" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
						</div>
					</section>
				</form>

				<!-- Actions -->
				<div class="flex items-center justify-end gap-3">
					<div id="cancel-btn"></div>
					<div id="submit-btn"></div>
				</div>
			</section>
		</main>

		<script src="/main.js"></script>
		<script src="/components/navbar/main.js"></script>
		<script src="/components/text_field/main.js"></script>
		<script src="/components/select_field/main.js"></script>
		<script src="/components/modal/main.js"></script>
		<script src="/components/button/main.js"></script>
		<script src="/components/checkbox_field/main.js"></script>
		<script src="/components/suspense_screen/main.js"></script>

		<script>
		const authStore = createAuthStore();

		const loadingScreen = mountSuspenseScreen("#loading-screen", {
			message: "Loading needed data...",
		});

		const apiConnector = createApiConnector();

		(async () => {
			try {
				await checkIsLoggedInMiddleware(authStore);

				const [
					jobTitles,
					companyDepartments,
					licenses,
					systemPermissions,
					mailingGroups,
					licenseToJobTitleMappings,
					systemPermissionToJobTitleMappings
				] = await Promise.all([
						apiConnector.getJobTitles(),
						apiConnector.getCompanyDepartments(),
						apiConnector.getLicenses(),
						apiConnector.getSystemPermissions(),
						apiConnector.getMailingGroups(),
						apiConnector.getLicenseToJobTitleMappings(),
						apiConnector.getSystemPermissionToJobTitleMappings(),
					]).then(result => {
						for (oneResult of result) {
							if (oneResult.unknownError !== null) {
								// throws error
								reportCriticalError(oneResult.unknownError);
							}
						}

						return result.map(oneResult => oneResult.ok);
					}).catch(reportCriticalError);

				loadingScreen.destroy();

				Array.from(document.querySelectorAll('[data-loading="show"]')).forEach(element => {
					element.classList.remove("hidden");
				});

				// Navbar
				const navbar = mountNavbar('#navbar-root', {
					brandHref: '/',
					brandName: 'Confilogi',
					brandAccent: 'IT Support',
					...LOGGED_IN_NAVBAR_ARGS
				});

				// Safe text helper for modal HTML content
				function escapeHtml(str) {
					return String(str).replace(/[&<>"']/g, s => ({
						'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
					}[s]));
				}

				function setRequiredLicenses() {
					let result = [];

					fields.licensesField.setChosen(
						licenseToJobTitleMappings
							.filter(mapping => mapping.jobTitleId === fields.jobTitleField.getChosen()[0])
							.map(mapping => mapping.licenseId)
					);

					if (fields.jobTitleField.getChosen().length > 0) {
						result = result.concat(
							licenseToJobTitleMappings
								.filter(mapping => mapping.jobTitleId === fields.jobTitleField.getChosen()[0])
								.map(mapping => mapping.licenseId)
						);
					}

					if (fields.jobSubtitleField.getChosen().length > 0) {
						result = result.concat(
							licenseToJobTitleMappings
								.filter(mapping => mapping.jobTitleId === fields.jobSubtitleField.getChosen()[0])
								.map(mapping => mapping.licenseId)
						);
					}

					fields.licensesField.enable();
					fields.licensesField.setChosen(result);

					if (fields.licensesField.getChosen().length > 0) {
						fields.licensesField.disable();
					} else {
						fields.licensesField.enable();
					}
				}

				function setRequiredSystemPermissions() {
					let result = [];

					if (fields.jobTitleField.getChosen().length > 0) {
						result = result.concat(
							systemPermissionToJobTitleMappings
								.filter(systemPermission => systemPermission.jobTitleId === fields.jobTitleField.getChosen()[0])
								.map(systemPermission => systemPermission.systemPermissionId)
						);
					}

					if (fields.jobSubtitleField.getChosen().length > 0) {
						result = result.concat(
							systemPermissionToJobTitleMappings
								.filter(systemPermission => systemPermission.jobTitleId === fields.jobSubtitleField.getChosen()[0])
								.map(systemPermission => systemPermission.systemPermissionId)
						);
					}

					fields.masterSystemsField.enable();
					fields.masterSystemsField.setChosen(result);

					if (fields.masterSystemsField.getChosen().length > 0) {
						fields.masterSystemsField.disable();
					} else {
						fields.masterSystemsField.enable();
					}
				}

				function synchronizeJobTitleItems() {
					fields.jobTitleField.enable();
					fields.jobTitleField.setItems(jobTitles
						.filter(jobTitle => jobTitle.company_department_id === fields.companyDepartmentField.getChosen()[0])
						.map(jobTitle => ({
							value: jobTitle.id,
							displayText: jobTitle.name,
						})));

					fields.jobSubtitleField.disable();
				}

				function synchronizeJobSubtitleItems() {
					fields.jobSubtitleField.setItems(jobTitles
						.filter(jobTitle => jobTitle.parent_job_title_id === fields.jobTitleField.getChosen()[0])
						.map(jobTitle => ({
							value: jobTitle.id,
							displayText: jobTitle.name,
						})));

					if (fields.jobSubtitleField.getItems().length > 0) {
						fields.jobSubtitleField.enable();
					}
				}

				function synchronizeSubpermissionCheckboxes() {
					Object.values(fields.subpermissions).forEach(subpermissionField => subpermissionField.destroy());
					fields.subpermissions = {};

					document.querySelector("#subpermissions-wrapper").innerHTML = '';

					const subpermissions = systemPermissions.filter(systemPermission => fields.masterSystemsField.getChosen().includes(systemPermission.subpermission_of_id));

					subpermissions.forEach(subpermission => {
						const id = `subpermission-${escapeHtml(subpermission.id)}-root`;

						const singleCheckboxWrapper = document.createElement("div");
						singleCheckboxWrapper.id = id;

						document.querySelector("#subpermissions-wrapper").appendChild(singleCheckboxWrapper);

						fields.subpermissions[subpermission.id] = mountCheckbox(
							`#${id}`, 
							{ 
								label: subpermission.name, 
								checked: !!requestedPermissionIds[subpermission.id],
								trueLabel: null, 
								falseLabel: null, 
								onChange: ({ checked }) => {
									requestedPermissionIds[subpermission.id] = checked;
								}
							}
						);
					});
				}

				const requestedPermissionIds = [];

				const masterSystems = systemPermissions
				.filter(systemPermission => systemPermission.subpermission_of_id === null)
				.map(masterSystem => ({
					value: masterSystem.id,
					displayText: masterSystem.name,
				}));

				const fields = {
					firstNameField: mountTextField('#first-name-field', {
						label: 'Name',
						type: 'text',
						placeholder: 'Enter name...',
						value: '',
						clearErrorOnInput: true,
					}),
					secondNameField: mountTextField('#second-name-field', {
						label: 'Second name (optional)',
						type: 'text',
						placeholder: 'Enter second name...',
						value: '',
						clearErrorOnInput: true,
					}),
					lastNameField: mountTextField('#last-name-field', {
						label: 'Surname',
						type: 'text',
						placeholder: 'Enter surname...',
						value: '',
						clearErrorOnInput: true,
					}),
					companyDepartmentField: mountSelectField(
						'#company-department-field', 
						companyDepartments.map(department => ({ 
							value: department.id, 
							displayText: department.name 
						})), {
							label: 'Company department',
							type: 'text',
							placeholder: 'Call center, Sales...',
							clearErrorOnInput: true,
							multiple: false,
							onSelect: () => {
								synchronizeJobTitleItems();
							},
						}),
					jobTitleField: mountSelectField('#job-title-field', [], {
						label: 'Job title',
						type: 'text',
						placeholder: 'Select job title...',
						clearErrorOnInput: true,
						multiple: false,
						onSelect: () => {
							synchronizeJobSubtitleItems();
							setRequiredLicenses();
							setRequiredSystemPermissions();
						},
						onRemove: () => {
							synchronizeJobSubtitleItems();
							setRequiredLicenses();
							setRequiredSystemPermissions();
						}
					}),
					jobSubtitleField: mountSelectField('#job-subtitle-field', [], {
						label: 'Job Subtitle',
						type: 'text',
						placeholder: 'Select job title...',
						clearErrorOnInput: true,
						multiple: false,
						onSelect: () => {
							setRequiredLicenses();
							setRequiredSystemPermissions();
						},
						onRemove: () => {
							setRequiredLicenses();
							setRequiredSystemPermissions();
						}
					}),
					workedBeforeSwitch: mountCheckbox("#worked-before-switch", { label: "" }),
					streetField: mountTextField('#street-field', {
						label: 'Street name',
						type: 'text',
						placeholder: 'e.g., Main Street',
						value: '',
						clearErrorOnInput: true,
					}),
					houseNumberField: mountTextField('#house-number-field', {
						label: 'House number',
						type: 'text',
						placeholder: 'e.g., 12A',
						value: '',
						clearErrorOnInput: true,
					}),
					apartmentNumberField: mountTextField('#apartment-number-field', {
						label: 'Apartment number (optional)',
						type: 'text',
						placeholder: 'e.g., 5',
						value: '',
						clearErrorOnInput: true,
					}),
					countryField: mountTextField('#country-field', {
						label: 'Country',
						type: 'text',
						placeholder: 'e.g., Poland',
						value: '',
						clearErrorOnInput: true,
					}),
					cityField: mountTextField('#city-field', {
						label: 'City',
						type: 'text',
						placeholder: 'e.g., Warsaw',
						value: '',
						clearErrorOnInput: true,
					}),
					postalCodeField: mountTextField('#postal-code-field', {
						label: 'Postal code',
						type: 'text',
						placeholder: 'e.g., 00-001',
						value: '',
						clearErrorOnInput: true,
					}),
					phoneField: mountTextField('#phone-field', {
						label: 'Cellphone number',
						type: 'text',
						placeholder: 'e.g., +48 600 000 000',
						value: '',
						clearErrorOnInput: true,
					}),
					emailField: mountTextField('#email-field', {
						label: 'Email address',
						type: 'email',
						placeholder: 'name@domain.com',
						value: '',
						clearErrorOnInput: true,
					}),
					hardwareLaptopField: mountCheckbox("#hardware-laptop-checkbox-root", {
						label: "Laptop"
					}),
					hardwareMouseField: mountCheckbox("#hardware-mouse-checkbox-root", {
						label: "Mouse"
					}),
					hardwareHeadsetField: mountCheckbox("#hardware-headset-checkbox-root", {
						label: "Headset"
					}),
					hardwareUsbCNetworkCardField: mountCheckbox("#hardware-usb-c-network-card-checkbox-root", {
						label: "USB-C Network Card"
					}),
					hardwareUsbAWirelessNetworkCardField: mountCheckbox("#hardware-usb-a-wireless-network-card-checkbox-root", {
						label: "USB-A Wireless Network Card"
					}),
					hardwareLaptopBagField: mountCheckbox("#hardware-laptop-bag-checkbox-root", {
						label: "Laptop bag"
					}),
					hardwarePhoneField: mountCheckbox("#hardware-phone-checkbox-root", {
						label: "Phone"
					}),
					hardwarePhoneChargerField: mountCheckbox("#hardware-phone-charger-checkbox-root", {
						label: "Phone charger"
					}),
					masterSystemsField: mountSelectField(
						"#master-systems-field", 
						masterSystems, 
						{
							label: "Master systems",
							placeholder: "Vici PL, Vici EU1, CRM EU, etc.",
							onSelect: ({ value, item, chosen }) => {
								synchronizeSubpermissionCheckboxes();
							},
							onRemove: () => {
								synchronizeSubpermissionCheckboxes();
							}
						}),
					licensesField: mountSelectField("#licenses-field", licenses.map(license => ({
						value: license.id,
						displayText: license.name,
					})), {
							label: "Licenses",
							placeholder: "Office on desktop, PowerBI Pro, etc.",
						}),
					groupsField: mountSelectField("#groups-field", mailingGroups.map(mailingGroup => ({
						value: mailingGroup.id,
						displayText: `${mailingGroup.name} (${mailingGroup.email})`
					})), {
							label: "Groups",
							placeholder: "e.g., CZ-SK Managers"
						}),
					cancelBtn: mountButton('#cancel-btn', {
						label: 'Cancel',
						variant: 'ghost',
						size: 'sm',
						onClick: () => {
							window.location.href = '/report-problem.html';
						}
					}),
					subpermissions: {}
				};


				fields.jobTitleField.disable();
				fields.jobSubtitleField.disable();

				const submitBtn = mountButton('#submit-btn', {
					label: 'Submit',
					variant: 'primary',
					size: 'md',
					type: 'button',
					onClick: () => {
						submitOnboarding();
					}
				});

				// Validation helpers
				function clearAllErrors() {
					[fields.firstNameField, fields.lastNameField, fields.streetField, 
						fields.houseNumberField, fields.countryField, fields.cityField, 
						fields.postalCodeField, fields.phoneField, 
						fields.emailField].forEach(f => f.clearError());
				}

				async function submitOnboarding() {
					clearAllErrors();

					// Gather
					const payload = {
						person: {
							name: fields.firstNameField.getValue().trim(),
							secondName: fields.secondNameField.getValue().trim(),
							surname: fields.lastNameField.getValue().trim(),
							companyDepartment: fields.companyDepartmentField.getChosen().length > 0 ?
								fields.companyDepartmentField.getChosen()[0] : null,
							jobTitle: fields.jobTitleField.getChosen().length > 0 ?
									fields.jobTitleField.getChosen()[0] : null,
							jubSubtitle: fields.jobSubtitleField.getChosen().length > 0 ?
									fields.jobSubtitleField.getChosen()[0] : null,
						},
						workedWithUsBefore: fields.workedBeforeSwitch.getValue(),
						postalAddress: {
							street: fields.streetField.getValue().trim(),
							houseNumber: fields.houseNumberField.getValue().trim(),
							apartmentNumber: fields.apartmentNumberField.getValue().trim(),
							country: fields.countryField.getValue().trim(),
							city: fields.cityField.getValue().trim(),
							postalCode: fields.postalCodeField.getValue().trim(),
							cellphone: fields.phoneField.getValue().trim(),
							email: fields.emailField.getValue().trim(),
						},
						hardware: [],
						permissions: [],
						licenses: fields.licensesField.getChosen(),
						mailingGroups: fields.groupsField.getChosen(),
					};

					if (fields.hardwareLaptopField.getValue()) payload.hardware.push('laptop');
					if (fields.hardwareMouseField.getValue()) payload.hardware.push('mouse');
					if (fields.hardwareHeadsetField.getValue()) payload.hardware.push('headset');
					if (fields.hardwareUsbCNetworkCardField.getValue()) payload.hardware.push('usb-c-network-card');
					if (fields.hardwareUsbAWirelessNetworkCardField.getValue()) payload.hardware.push('usb-a-wireless-network-card');
					if (fields.hardwareLaptopBagField.getValue()) payload.hardware.push('laptop-bag');
					if (fields.hardwarePhoneField.getValue()) payload.hardware.push('phone');
					if (fields.hardwarePhoneChargerField.getValue()) payload.hardware.push('phone-charger');

					payload.permissions = fields.masterSystemsField.getChosen();

					Object.keys(fields.subpermissions).forEach(subpermissionId => {
						if (fields.subpermissions[subpermissionId].getValue()) {
							payload.permissions.push(parseInt(subpermissionId));
						}
					});

					console.log(payload);
				}
			} catch (error) {
				reportCriticalError(error);
			}
		})();

		</script>
	</body>
</html>
